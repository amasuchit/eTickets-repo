@model eTickets.ViewModel.CartViewModel
@{
    ViewData["Title"] = "Your Cart";
}

<div class="container">
    <h2>Your Cart</h2>

    @if (Model.CartItems.Count == 0)
    {
            <div class="alert alert-info">Your cart is empty.</div>
            <a asp-controller="Movie" asp-action="Index" class="btn btn-primary">Continue Shopping</a>
    }
    else
    {
            <table class="table">
                <thead>
                    <tr>
                        <th>Movie</th>
                        <th>Price</th>
                        <th>Quantity</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var item in Model.CartItems)
                {
                            <tr>
                                <td>@item.MovieName</td>
                                <td>NRs. @item.Price.ToString("N2")</td>
                                <td>
                                    <form asp-action="UpdateQuantity" method="post" class="update-quantity-form">
                                        <input type="hidden" name="movieId" value="@item.MovieId" />
                                        <input type="number" name="quantity" value="@item.Quantity" min="1" class="form-control quantity-input" style="width: 70px" data-movie-id="@item.MovieId" />
                                    </form>
                                </td>
                                <td class="item-total">NRs. @item.TotalPrice.ToString("N2")</td>
                                <td>
                                    <form asp-action="RemoveFromCart" method="post">
                                        <input type="hidden" name="movieId" value="@item.MovieId" />
                                        <button type="submit" class="btn btn-danger btn-sm">Remove</button>
                                    </form>
                                </td>
                            </tr>
                }
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-right">Total:</th>
                        <th class="cart-total">NRs. @Model.CartTotal.ToString("N2")</th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>

            <div class="d-flex justify-content-between">
                <a asp-controller="Movie" asp-action="Index" class="btn btn-primary">Continue Shopping</a>
                <a asp-controller="Checkout" asp-action="Index" class="btn btn-success">Proceed to Checkout</a>
            </div>
    }
</div>

@section Scripts {
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <script>
            $(document).ready(function () {
                $('.quantity-input').on('change', function () {
                    var $input = $(this);
                    var movieId = $input.data('movie-id');
                    var quantity = parseInt($input.val());
                    var $form = $input.closest('form');
                    var $row = $input.closest('tr');
                    var $itemTotal = $row.find('.item-total');
                    var $cartTotal = $('.cart-total');

                    // Validate quantity
                    if (isNaN(quantity) || quantity < 0) {
                        quantity = 1;
                        $input.val(quantity);
                    }

                    // Send AJAX request to UpdateQuantity
                    $.ajax({
                        url: '/Cart/UpdateQuantity',
                        type: 'POST',
                        data: { movieId: movieId, quantity: quantity },
                        success: function (response) {
                            if (response.success) {
                                // Update item total
                                var newItemTotal = response.itemTotal.toFixed(2);
                                $itemTotal.text('NRs. ' + newItemTotal);

                                // Update cart total
                                var newCartTotal = response.cartTotal.toFixed(2);
                                $cartTotal.text('NRs. ' + newCartTotal);

                                // If quantity is 0, remove the row
                                if (quantity === 0) {
                                    $row.remove();
                                    // Check if cart is empty
                                    if ($('.quantity-input').length === 0) {
                                        $('.container').html(
                                            '<div class="alert alert-info">Your cart is empty.</div>' +
                                            '<a href="/Movie/Index" class="btn btn-primary">Continue Shopping</a>'
                                        );
                                    }
                                }
                            } else {
                                alert('Error updating quantity: ' + (response.message || 'Unknown error'));
                                $input.val(response.currentQuantity || 1); // Revert to last valid quantity
                            }
                        },
                        error: function () {
                            alert('Error updating quantity. Please try again.');
                            $input.val($input.data('last-value') || 1); // Revert to last valid value
                        }
                    });

                    // Store last valid value
                    $input.data('last-value', quantity);
                });

                // Store initial quantity as last valid value
                $('.quantity-input').each(function () {
                    $(this).data('last-value', $(this).val());
                });
            });
        </script>
}